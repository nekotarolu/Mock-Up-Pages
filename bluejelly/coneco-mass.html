<!doctype html>
<!--
Copyright 2017 JellyWare Inc. All Rights Reserved.
-->
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="BlueJelly">
  <meta name="viewport" content="width=640, maximum-scale=1.0, user-scalable=yes">
  <title>BlueJelly</title>
  <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="bluejelly.js"></script>
</head>

<body>
  <div class="container">
    <div class="title margin">
      <p id="title">ConecO-Mass</p>
      <p id="subtitle">＜後付けできるsmart mass scale＞</p>
    </div>

    <div class="contents margin">
      <button id="startNotifications" class="button">Read</button>
      <button id="stopNotifications" class="button">Stop</button>
      <hr>
      <div id="device_name"> </div>
      <div id="uuid_name"> </div>
      <div id="unit"> </div>
      <div id="data_text"> </div>
      <div id="status_text"> </div>
      <div id="status"> </div>

    </div>
  </div>
  <script>
    //--------------------------------------------------
    //Global変数
    //--------------------------------------------------
    //BlueJellyのインスタンス生成
    var ble = new BlueJelly();


    //--------------------------------------------------
    //ロード時の処理
    //--------------------------------------------------
    window.onload = function () {
      //UUIDの設定
      ble.setUUID("UUID1", "713d0000-503e-4c75-ba94-3148f18d941e", "713d0002-503e-4c75-ba94-3148f18d941e");  //BLEnano SimpleControl rx_uuid
    }


    //--------------------------------------------------
    //Scan後の処理
    //--------------------------------------------------
    ble.onScan = function (deviceName) {
      //document.getElementById('device_name').innerHTML = deviceName;
      //document.getElementById('status').innerHTML = "found device!";
    }


    //--------------------------------------------------
    //ConnectGATT後の処理
    //--------------------------------------------------
    ble.onConnectGATT = function (uuid) {
      console.log('> connected GATT!');

      //document.getElementById('uuid_name').innerHTML = uuid;
      //document.getElementById('status').innerHTML = "connected GATT!";
    }

    counter = 0;

    //--------------------------------------------------
    //Read後の処理：得られたデータの表示など行う
    //--------------------------------------------------
    ble.onRead = function (data, uuid) {
      //フォーマットに従って値を取得
      value = Math.round(data.getInt16(0) * 0.771 - 126.48) - 252;//2Byteの場合のフォーマット

      //-378は空ビンの重さと校正時の切片の合計。浮かせているときは-378になる
      if (-100 <= value && value <= 10) {
        attention = "コーヒーがなくなりました。</br>LINEにお知らせしました。";
      }
      else if (11 <= value && value <= 50) {
        attention = "そろそろコーヒーがなくなりそうです。</br>LINEにお知らせしました。"
      }
      else if (value <= -101) {
        attention = "使用中・・・"
      }
      else {
        attention = "まだ十分残っています"
      }

      if (value <= 0) {
        value = 0;
      }

      if (counter == 3) {
        pre_value1 = value;
        counter++;
      }

      if (counter == 5) {
        pre_value2 = value;
        counter++;
      }

      if (counter == 8) {
        pre_value3 = value;
        counter++;
      }

      if (counter >= 10) {

        var xhr = new XMLHttpRequest();
        var url = "https://stack-string.herokuapp.com/PushStack/mass?string="
          + encodeURIComponent(attention);
        xhr.open("POST", url, true);
        xhr.send("");
        counter = 0;

        value_fin = (pre_value1 + pre_value2 + pre_value3 + value) / 4

        //HTMLに値を表示
        document.getElementById('unit').innerHTML = "コーヒーの残量：";
        document.getElementById('data_text').innerHTML = Math.round(value_fin) + 'g';
        document.getElementById('status_text').innerHTML = attention;

      }
      else {
        counter++;
      }
      //コンソールに値を表示
      console.log(value);

    }


    //--------------------------------------------------
    //Start Notify後の処理
    //--------------------------------------------------
    ble.onStartNotify = function (uuid) {
      console.log('> Start Notify!');

      //document.getElementById('uuid_name').innerHTML = uuid;
      //document.getElementById('status').innerHTML = "測定中...";
    }


    //--------------------------------------------------
    //Stop Notify後の処理
    //--------------------------------------------------
    ble.onStopNotify = function (uuid) {
      console.log('> Stop Notify!');

      //document.getElementById('uuid_name').innerHTML = uuid;
      //document.getElementById('status').innerHTML = "stopped Notify";
    }


    //-------------------------------------------------
    //ボタンが押された時のイベント登録
    //--------------------------------------------------
    document.getElementById('startNotifications').addEventListener('click', function () {
      ble.startNotify('UUID1');
    });

    document.getElementById('stopNotifications').addEventListener('click', function () {
      ble.stopNotify('UUID1');
    });


  </script>
</body>

</html>